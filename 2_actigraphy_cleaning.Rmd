---
title: "actigraphy_cleaning"
author: "Jackie"
date: "5/31/2021; 6/11/21; 7/4/21"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

This script wrangles actigraphy data for subsequent analyses
# libraries   

```{r, message=FALSE}
library(tidyverse)
library(naniar)
library(lubridate)
```

# reading in databases

```{r, message=FALSE, echo=FALSE, warning=FALSE}
d1_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/Database_1_Export.csv"
d2_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/Database_2_Export.csv"
d3_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/Database_3_Export.csv"
d4_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/Database_4_Export.csv"
cov_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/ELS_COVID_Database_Export.csv"
d4_cov_fp <- "~/Box/Mooddata_Coordinating/ELS_RDoC/At Home Components/2. Actiwatch/Exported Actogram CSVs/database_exports/ELS_COVID_subjs_from_Database_4.csv"

d1 <- read_csv(d1_fp)
d2 <- read_csv(d2_fp)
d3 <- read_csv(d3_fp)
d4 <- read_csv(d4_fp)
cov <- read_csv(cov_fp)
d4_cov <- read_csv(d4_cov_fp)

cov %>%
  mutate(
    start_date_time = mdy(start_date)
  ) %>%
  summarize(start_date_max = max(start_date_time))

d4_cov %>%
  mutate(
    start_date_time = mdy(start_date)
  ) %>%
  summarize(start_date_max = max(start_date_time))

d4 %>%
  mutate(
    start_date_time = mdy(start_date)
  ) %>%
  summarize(start_date_max = max(start_date_time))

write_csv(d1, "d1_actigraphy.csv")
write_csv(d2, "d2_actigraphy.csv")
write_csv(d3, "d3_actigraphy.csv")
write_csv(d4, "d4_actigraphy.csv")
write_csv(cov, "cov_actigraphy.csv")
write_csv(d4_cov, "covid_ps_from_d4_actigraphy.csv")
```

# cleaning databases
filter only for sleep intervals, and selecting only efficiency

```{r, cleaning}
options(scipen = 999)
# From Reed & Sacco
# DSE <- onset_latency + TST + WASO + TASAFA
# SE = (sleep_time/DSE)*100
  
d_vars <- c("data_start_date","onset_latency", "snooze_time", "efficiency", "duration", "sleep_time", "waso", "wake_time", "percent_wake", "number_of_wake_bouts", "avg_wake_b", "sleep_time", "number_of_sleep_bouts")

# d1
d1_clean <-
  d1 %>%
  rename(
    ELS_ID = subject_id
  ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%  
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  )

# d2
d2_clean <-
  d2 %>%
  rename(
    ELS_ID = subject_id
  ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%  
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  ) 

# d3
d3_clean <-
  d3 %>%
  rename(
    ELS_ID = subject_id
  ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%  
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  )

# d4
# in this database 2 ids were entered as each other by accident, so separating now by date administered correclty
### 109 was 6/23
### 171 was 7/8
d4_clean <-
  d4 %>%
  rename(
    ELS_ID = subject_id
  ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID_chr =
      ifelse(
        str_detect(ELS_ID, "171-T3 and 109-T3") &
          str_detect(data_start_date, "6/23/2019"),
        "109-T3",
        NA
        )
    ) %>%
  mutate(
    ELS_ID_chr =
      ifelse(
        str_detect(ELS_ID, "171-T3 and 109-T3") &
          str_detect(data_start_date, "7/7/2019"),
        "171-T3",
        ELS_ID_chr
        )
    ) %>%
  relocate(ELS_ID_chr, .after = ELS_ID) %>%
  mutate(
    ELS_ID_chr =
      ifelse(is.na(ELS_ID_chr),
             ELS_ID,
             ELS_ID_chr)
  ) %>%
  dplyr::select(-ELS_ID) %>%
  rename(
    ELS_ID = ELS_ID_chr
  ) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%  
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  filter(
    ELS_ID != "196" # using 196x in the cov df bc aligns with MW
  ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  )

# covid df
cov_clean <- 
  cov %>%
  rename(
    ELS_ID = subject_id
    ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        ),
    timepoint =
      ifelse(
        str_detect(ELS_ID,"x-T3"),
        "T3x",
        timepoint
      ),
    timepoint =
      ifelse(
        str_detect(ELS_ID, "T4"),
        "T4",
        timepoint
      )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = str_remove(ELS_ID, "-T4"),
    ELS_ID = str_remove(ELS_ID, "x"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  )

# participants administered actigraphy during COVID-19 from database 4
d4_cov_clean <- 
  d4_cov %>%
  rename(
    ELS_ID = subject_id
    ) %>%
  mutate(
    ELS_ID = as.character(ELS_ID),
    timepoint = 
      ifelse(
        str_detect(ELS_ID, "T3"),
        "T3",
        NA
        ),
    timepoint =
      ifelse(
        str_detect(ELS_ID, "T4"),
        "T4",
        timepoint
      )
    ) %>%
  relocate(timepoint, .after = ELS_ID) %>%
  mutate(
    ELS_ID = str_remove(ELS_ID, "-T3"),
    ELS_ID = str_remove(ELS_ID, "-T4"),
    ELS_ID = str_remove(ELS_ID, "x"),
    ELS_ID = as.numeric(ELS_ID),
    ELS_ID = factor(ELS_ID)
  ) %>%
  filter(interval_type == "SLEEP") %>%
  dplyr::select(ELS_ID, 
                timepoint,
                data_start_date,
                data_start_time,
                interval_type,
                interval_number,
                start_date,
                start_time,
                end_date,
                end_time,
                duration,
                onset_latency,
                snooze_time,
                efficiency,
                waso,
                wake_time,
                percent_wake,
                number_of_wake_bouts,
                avg_wake_b,
                sleep_time,
                percent_sleep,
                number_of_sleep_bouts,
                avg_sleep_b,
                inv_time_sw) %>%
  filter(
    !is.na(interval_number)
    ) %>%
  filter(
    inv_time_sw == 0
    ) %>%
  mutate(
    sleep_time_hrs = sleep_time/60
  ) 
```


# extracting data start date for reduced dataframe
```{r}
d1_clean_startdate_red <-
  d1_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique() %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d2_clean_startdate_red <-
  d2_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d3_clean_startdate_red <-
  d3_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d4_clean_startdate_red <-
  d4_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

cov_clean_startdate_red <-
  cov_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d4_cov_clean_startdate_red <-
  d4_cov_clean %>%
  dplyr::select(ELS_ID, data_start_date, timepoint) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date)
  ) %>%
  dplyr::select(-data_start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))
```



# extracting data start date for long datafame
```{r}
d1_clean_startdate <-
  d1_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique() %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d2_clean_startdate <-
  d2_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d3_clean_startdate <-
  d3_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d4_clean_startdate <-
  d4_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

cov_clean_startdate <-
  cov_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))

d4_cov_clean_startdate <-
  d4_cov_clean %>%
  dplyr::select(ELS_ID, data_start_date, start_date) %>%
  unique()  %>%
  mutate(
    actigraphy_start_date = mdy(data_start_date),
    start_date = mdy(start_date),
    actigraphy_day = day(start_date)
  ) %>%
  dplyr::select(-data_start_date, -start_date) %>%
  mutate(ELS_ID = factor(ELS_ID))
```


## merging long-form dataframes
```{r}
# making start times the same object
d3_clean_time <-
  d3_clean %>%
  mutate(
    start_time = as.character(start_time),
    end_time = as.character(end_time)
  )

d4_clean_time <-
  d4_clean %>%
  mutate(
    start_time = as.character(start_time),
    end_time = as.character(end_time)
  )

cov_clean_time <-
  cov_clean %>%
  mutate(
    start_time = as.character(start_time),
    end_time = as.character(end_time)
  )

d4_cov_clean_time <-
  d4_cov_clean %>%
  mutate(
    start_time = as.character(start_time),
    end_time = as.character(end_time)
  )

actig_long <- bind_rows(d1_clean, d2_clean, d3_clean_time, d4_clean_time, cov_clean_time, d4_cov_clean_time)


actig_long_2wk <-
  actig_long %>%
  filter(
    interval_number < 15
  )
```

## merging reduced dataframes
# reducing dataframes
taking the average of efficiency over the span of the 14 days to get a more "representative" efficiency
```{r}
# d1
d1_reduced <- 
  d1_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID) %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
    )

d1_reduced <-
  left_join(
    d1_clean_startdate_red,
    d1_reduced,
    by = "ELS_ID"
  )

# d2
d2_reduced <- 
  d2_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID)  %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
    )

d2_reduced <-
  left_join(
    d2_clean_startdate_red,
    d2_reduced,
    by = "ELS_ID"
  )

# d3
d3_reduced <- 
  d3_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID) %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
    )

d3_reduced <-
  left_join(
    d3_clean_startdate_red,
    d3_reduced,
    by = "ELS_ID"
  )

# d4
d4_reduced <- 
  d4_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID)  %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
    )

d4_reduced <-
  left_join(
    d4_clean_startdate_red,
    d4_reduced,
    by = "ELS_ID"
  )

# cov
cov_reduced <-
  cov_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID)  %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
    )

cov_reduced <-
  left_join(
    cov_clean_startdate_red,
    cov_reduced,
    by = "ELS_ID"
  )

# d4 cov
d4_cov_reduced <-
  d4_cov_clean %>%
  mutate(
    ELS_ID = as.factor(ELS_ID)
  ) %>%
  group_by(ELS_ID)  %>%
  summarize(
    eff_perc_mean =
      mean(efficiency, na.rm = TRUE),
    eff_perc_sd =
      sd(efficiency, na.rm = TRUE),
    onset_lat_mean = 
      mean(onset_latency, na.rm = TRUE),
    onset_lat_sd =
      sd(onset_latency, na.rm = TRUE),
    snooze_mean =
      mean(snooze_time, na.rm = TRUE),
    snooze_sd = 
      sd(snooze_time, na.rm = TRUE),
    sleep_dur_mean =
      mean(sleep_time, na.rm = TRUE),
    sleep_dur_sd = 
      sd(sleep_time, na.rm = TRUE),
    sleep_time_hrs_mean =
      mean(sleep_time_hrs, na.rm = TRUE),
    sleep_time_hrs_sd =
      sd(sleep_time_hrs, na.rm = TRUE)
  )

d4_cov_reduced <-
  left_join(
    d4_cov_clean_startdate_red,
    d4_cov_reduced,
    by = "ELS_ID"
  )

```

```{r}
actig_merged <- bind_rows(d1_reduced, d2_reduced, d3_reduced, d4_reduced, cov_reduced, d4_cov_reduced)
```

# Data Viz

## Day to Day sleep efficiency (software based)
```{r sleep eff}
actig_long_2wk %>%
  ggplot(
    aes(
      interval_number,
      efficiency,
      group = ELS_ID
      )
    ) +
  geom_line(
    alpha = 1/2
    ) +
  facet_wrap(~ELS_ID) +
  theme_minimal() +
  theme(
    strip.text.x = element_blank()
    ) +
  labs(
    x = "Day",
    y = "Sleep Efficiency"
    ) +
 scale_y_continuous(limits = c(0,100))
ggsave("daily_act_sleep_eff_traj.png", width = 7, height = 7, dpi = 400)
```


## Day to Day sleep dur
```{r sleep time}
actig_long_2wk %>%
  ggplot(
    aes(
      interval_number,
      sleep_time_hrs,
      group = ELS_ID
      )
    ) +
  geom_line(
    alpha = 1/2
    ) +
  facet_wrap(~ELS_ID) +
  theme_minimal() +
  theme(
  strip.text.x = element_blank()
  ) +
  labs(
    x = "Day",
    y = "Sleep Time (hrs)"
    ) 
ggsave("daily_act_sleep_time_traj.png", width = 7, height = 7, dpi = 400)
```


# sleep instability?

computing the rmssd as per Koval et al., 2013; Jahng et al., 2008
The RMSSD is measured as the square root of the average of the squared differences between affect at measurement i and i + 1 (Schoevers et al., 2020)
```{r}
sleep_lag_df <-
  actig_long_2wk  %>%
  dplyr::select(
    ELS_ID,interval_number, efficiency, sleep_time, sleep_time_hrs
  ) %>%
  group_by(ELS_ID) %>%
  summarize(
    # step 1: computing successive difference
    sleep_eff_succ_diff = efficiency - lag(efficiency),
    sleep_hrs_succ_diff = sleep_time_hrs - lag(sleep_time_hrs),
    # step 2: computing square of each diff
    sleep_eff_sq_succ_diff = sleep_eff_succ_diff^2,
    sleep_hrs_sq_succ_diff = sleep_hrs_succ_diff^2
  )
sleep_mssd_df <-
  sleep_lag_df %>%
  group_by(ELS_ID) %>%
  summarize(
    # step 3: averaging the squared differences
    mean_sq_sleep_eff_succ_diff = mean(sleep_eff_sq_succ_diff, na.rm = TRUE),
    mean_sq_sleep_hrs_succ_diff = mean(sleep_hrs_sq_succ_diff, na.rm = TRUE),
    # step 4: computing square root of the average
    rmssd_sleep_eff = sqrt(mean_sq_sleep_eff_succ_diff),
    rmssd_sleep_hrs = sqrt(mean_sq_sleep_hrs_succ_diff)
  ) %>%
  mutate(ELS_ID = factor(ELS_ID))

```


#### joining dataframes
```{r}
actig_sleep <-
  left_join(
    actig_merged,    
    sleep_mssd_df,
    by = "ELS_ID"
  ) %>%
  relocate(actigraphy_start_date, .after = ELS_ID)
```

## summary stats
```{r}
actig_sleep_summary <-
  actig_sleep %>%
  summarize(
    n = n(),
    sleep_eff_mean = mean(eff_perc_mean),
    sleep_eff_sd = sd(eff_perc_mean),
    sleep_time_mean = mean(sleep_dur_mean),
    sleep_time_sd = sd(sleep_dur_mean),
    sleep_time_hrs_mean = mean(sleep_time_hrs_mean),
    sleep_time_hrs_sd = sd(sleep_time_hrs_mean)
  )
write_csv(actig_sleep_summary, "actig_sleep_summary_stats.csv")  
```

# Data Viz

## distributions of sleep eff

```{r sleep eff plots}

# mean
sleep_eff_mean <- 
  actig_sleep %>%
  ggplot(
    aes(x = eff_perc_mean)
  ) +
  geom_histogram(alpha = .5, color="black") +
  theme_classic() 
ggsave("daily_eff_mean.png", sleep_eff_mean, width = 7, height = 6.5)

# sd
sleep_eff_sd <- 
  actig_sleep %>%
  ggplot(
    aes(x = eff_perc_sd)
  ) +
  geom_histogram(alpha = .5, color = "black") +
  theme_classic() 
ggsave("daily_eff_sd.png", sleep_eff_sd, width = 7, height = 6.5)

```


## distributions of sleep  time

```{r sleep time plots}
# mean
sleep_time_mean <- 
  actig_sleep %>%
  ggplot(
    aes(x = sleep_time_hrs_mean)
  ) +
  geom_histogram(alpha = .5, color="black") +
  theme_classic() 
ggsave("daily_time_mean.png", sleep_time_mean, width = 7, height = 6.5)

# rmssd
sleep_time_rmssd <- 
  actig_sleep %>%
  ggplot(
    aes(x = rmssd_sleep_hrs)
  ) +
  geom_histogram(alpha = .5, color="black") +
  theme_classic() 
ggsave("daily_time_rmssd.png", sleep_time_rmssd, width = 7, height = 6.5)
```

### writing out reduced and long form actigraphy dataframe
```{r}
write_csv(actig_sleep, "~/Box/Mooddata_Coordinating/1_Lab_Coordinating/Users/JackieSchwartz/Dissertation/0_MW_Act_Demo_Descriptives/actig_merged.csv")
write_csv(actig_long_2wk, "~/Box/Mooddata_Coordinating/1_Lab_Coordinating/Users/JackieSchwartz/Dissertation/0_MW_Act_Demo_Descriptives/actig_long.csv")
```

